{% extends 'base.html' %}
{% block content %}
<h1 class="mb-4">Menú de proyectos (Crear, editar, cambiar estatus de proyectos)</h1>

<!-- Contenedor estilizado para el buscador, creación y descarga -->
<div class="card shadow-sm mb-4" style="background-color: #f8f9fa;">
    <div class="card-body">
        <!-- Formulario de búsqueda -->
        <form method="get" class="d-flex align-items-center mb-3">
            <div class="me-3">
                <label for="titulo" class="form-label">{{ task.form.titulo.label }}</label><br>
                {{ task.form.titulo }}
            </div>
            <div class="me-3">
                <label for="estatus" class="form-label">Estatus</label><br>
                <select id="estatus" name="estatus" class="form-select">
                    <option value="">Todos</option>
                    {% for estatus in estatus_disponibles %}
                        <option value="{{ estatus.id }}" {% if request.GET.estatus == estatus.id|stringformat:"s" %}selected{% endif %}>
                            {{ estatus.nombre }}
                        </option>
                    {% endfor %}
                </select>                
            </div>
            <div><br>
                <button type="submit" class="btn btn-primary me-2">Buscar</button>
                <a href="{% url 'task' %}" class="btn btn-secondary">Limpiar filtro</a>
            </div>
        </form>

        <!-- Botón para crear nuevo proyecto -->
        <div class="d-flex justify-content-between align-items-center">
            <a href="/signupKL/task/create" class="btn btn-success">
                Crear Nuevo Proyecto
            </a>

            <!-- Botón dropdown para descargar CSV -->
            <div class="dropdown">
                <button class="btn btn-primary dropdown-toggle" type="button" id="dropdownCSV" data-bs-toggle="dropdown" aria-expanded="false">
                    Descargar lista de proyectos
                </button>
                <ul class="dropdown-menu" aria-labelledby="dropdownCSV">
                    {% for estatus in estatus_disponibles %}
                        <li>
                            <a class="dropdown-item" href="{% url 'descargar_csv' %}?filtro={{ estatus.id }}">
                                {{ estatus.nombre }}
                            </a>
                        </li>
                    {% endfor %}
                    <li><a class="dropdown-item" href="{% url 'descargar_csv' %}?filtro=all">Todos los proyectos</a></li>
                </ul>
            </div>            
        </div>
    </div>
</div>

<!-- Resultados de proyectos -->
<table class="table table-bordered table-striped">
    <thead class="table-dark">
        <tr>
            <th>Título</th>
            <th>Portada</th>
            <th>Estatus</th>
            <th>Descripción</th>
            <th>Subido por</th>
            <th>Fecha de subida</th>
            <th>Acciones</th>
        </tr>
    </thead>
    <tbody>
        {% for Proyecto in task.qs %}
            <tr>
                <td>{{ Proyecto.titulo }}</td>
                <td>
                    {% if Proyecto.Portada_de_proyecto %}
                        <img src="{{ Proyecto.Portada_de_proyecto.url }}" alt="Portada de {{ Proyecto.titulo }}" style="max-width: 100px;">
                    {% else %}
                        No disponible
                    {% endif %}
                </td>
                <td>
                    {% if Proyecto.estatus %}
                        <span class="badge" style="background-color: {{ Proyecto.estatus.color }};">
                            {{ Proyecto.estatus.nombre }}
                        </span>
                    {% else %}
                        <span class="badge bg-secondary">Sin estatus</span>
                    {% endif %}
                </td>
                <td>{{ Proyecto.descripcion|truncatechars:50 }}</td>
                <td>
                    {% if Proyecto.Empleado_Responsable.first_name or Proyecto.Empleado_Responsable.last_name %}
                        {{ Proyecto.Empleado_Responsable.first_name }} {{ Proyecto.Empleado_Responsable.last_name }}
                    {% else %}
                        {{ Proyecto.Empleado_Responsable.username }}
                    {% endif %}
                </td>
                <td>{{ Proyecto.FechaDeAgregado|date:"d M Y" }}</td>
                <td><a href="{% url 'project_edit' Proyecto.id %}" class="btn btn-sm btn-primary">Editar</a></td>
            </tr>
        {% empty %}
            <tr>
                <td colspan="7" class="text-center">No se encontraron proyectos que coincidan con la búsqueda.</td>
            </tr>
        {% endfor %}
    </tbody>    
</table>
<br>
{% endblock %}
